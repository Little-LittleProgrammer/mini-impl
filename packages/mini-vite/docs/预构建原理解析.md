# 依赖预构建 (Dependency Pre-Bundling) 原理解析

## 1. 原理概述

依赖预构建是 Vite 开发环境中的一个关键优化，它解决了两个主要问题：

1. **CommonJS 和 UMD 兼容性**：开发阶段中，Vite 的开发服务器会将所有代码视为原生 ES 模块。因此，Vite 必须先将作为 CommonJS 或 UMD 发布的依赖项转换为 ES 模块。
2. **性能优化**：Vite 将有许多内部模块的 ESM 依赖关系转换为单个模块，以提高后续页面加载性能。

## 2. 实现细节

在 `optimizer/index.ts` 中，预构建过程包括以下步骤：

1. **依赖扫描**：使用 esbuild 插件扫描项目中的所有裸模块导入（bare import）
2. **依赖分析**：确定需要预构建的第三方依赖项
3. **预构建执行**：使用 esbuild 对依赖项进行批量构建
4. **产物存储**：将构建产物存储在 `node_modules/.mini-vite/deps` 目录下

## 3. 核心组件

### 3.1 依赖扫描器 (scanPlugin.ts)

依赖扫描器使用 esbuild 插件机制来扫描项目中的所有裸模块导入：

```typescript
// 扫描阶段插件
const scanPlugin: Plugin = {
  name: 'mini-vite:dep-scan',
  setup(build) {
    // 捕获所有裸导入
    build.onResolve({ filter: /^[\w@][^:]/ }, ({ path: id }) => {
      // 将裸导入添加到依赖列表
      deps.add(id)
      return {
        path: id,
        external: true
      }
    })
  }
}
```

### 3.2 预构建器 (index.ts)

预构建器负责实际执行依赖项的构建工作：

```typescript
export async function optimizeDeps(config: DepOptimizationConfig) {
  // 1. 扫描依赖
  const deps = await scanDependencies(config)
  
  // 2. 执行预构建
  const result = await build({
    absWorkingDir: process.cwd(),
    entryPoints: Object.keys(flatIdDeps),
    bundle: true,
    format: 'esm',
    splitting: true,
    outdir: processingCacheDir,
    // 其他配置...
  })
  
  // 3. 存储构建产物
  // ...
}
```

## 4. 配置参数

预构建使用 esbuild 的以下配置：

```javascript
{
  format: "esm",        // 输出格式为 ES 模块
  splitting: true,      // 启用代码分割
  bundle: true,         // 启用打包
  target: "esnext",     // 目标浏览器版本
}
```

## 5. 导入路径重写

在 `plugins/importAnalysis.ts` 中，分析模块导入语句并将第三方依赖的路径重写为预构建产物路径：

```javascript
// 转换前
import { createApp } from 'vue'

// 转换后
import { createApp } from '/node_modules/.mini-vite/deps/vue.js'
```

这个重写过程确保了浏览器加载的是经过预构建和模块格式转换的版本。

## 6. 缓存机制

预构建实现了缓存机制来避免不必要的重复构建：

1. **依赖哈希**：基于依赖项内容计算哈希值
2. **缓存验证**：检查缓存是否有效
3. **增量构建**：只重新构建发生变化的依赖项

## 7. 性能优化

### 7.1 并行处理

预构建过程利用了 esbuild 的并行处理能力，同时处理多个依赖项。

### 7.2 代码分割

通过启用 `splitting` 选项，esbuild 会自动进行代码分割，优化加载性能。

## 8. 错误处理

预构建过程包含了完善的错误处理机制：

1. **构建错误捕获**：捕获 esbuild 构建过程中的错误
2. **依赖解析错误**：处理依赖项解析失败的情况
3. **文件系统错误**：处理文件读写错误

## 9. 与其他模块的交互

### 9.1 与插件系统的交互

预构建过程利用了插件系统来扫描依赖项，确保与项目配置保持一致。

### 9.2 与 HMR 的交互

预构建产物在 HMR 过程中也会被更新，确保热更新的正确性。

### 9.3 与模块解析的交互

预构建产物的路径会被模块解析器识别，确保正确的模块加载。