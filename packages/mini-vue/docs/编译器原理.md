# Vue3 ç¼–è¯‘å™¨åŸç†è¯¦è§£

Vue3 çš„ç¼–è¯‘å™¨æ˜¯å°†æ¨¡æ¿è¯­æ³•è½¬æ¢ä¸ºå¯æ‰§è¡Œ JavaScript ä»£ç çš„æ ¸å¿ƒç»„ä»¶ã€‚å®ƒé‡‡ç”¨ä¸‰é˜¶æ®µç¼–è¯‘æµç¨‹ï¼š**è§£æï¼ˆParseï¼‰** â†’ **è½¬æ¢ï¼ˆTransformï¼‰** â†’ **ä»£ç ç”Ÿæˆï¼ˆCodegenï¼‰**ï¼ˆCodegenï¼‰ï¼Œå®ç°äº†é«˜æ•ˆçš„æ¨¡æ¿ç¼–è¯‘ã€‚

## ç¼–è¯‘å™¨æ¶æ„

Vue3 ç¼–è¯‘å™¨é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œåˆ†ä¸ºä¸¤ä¸ªä¸»è¦åŒ…ï¼š

- **compiler-core**: å¹³å°æ— å…³çš„æ ¸å¿ƒç¼–è¯‘é€»è¾‘
- **compiler-dom**: DOM å¹³å°ç‰¹å®šçš„ç¼–è¯‘æ‰©å±•

è¿™ç§è®¾è®¡ä½¿å¾—ç¼–è¯‘å™¨å¯ä»¥è½»æ¾é€‚é…ä¸åŒçš„å¹³å°ï¼Œå¦‚ Webã€å°ç¨‹åºç­‰ã€‚

### æ•´ä½“æµç¨‹

```
æ¨¡æ¿å­—ç¬¦ä¸² â†’ AST â†’ JavaScript AST â†’ æ¸²æŸ“å‡½æ•°ä»£ç 
```

```mermaid
sequenceDiagram
    participant Template as æ¨¡æ¿å­—ç¬¦ä¸²
    participant Parser as è§£æå™¨ (Parser)
    participant AST as æŠ½è±¡è¯­æ³•æ ‘ (AST)
    participant Transformer as è½¬æ¢å™¨ (Transformer)
    participant JAST as JavaScript AST
    participant Codegen as ä»£ç ç”Ÿæˆå™¨
    participant Code as æ¸²æŸ“å‡½æ•°ä»£ç 
    
    Template->>Parser: 1. è¾“å…¥æ¨¡æ¿
    Note over Parser: è¯æ³•åˆ†æ & è¯­æ³•åˆ†æ
    Parser->>AST: 2. ç”Ÿæˆåˆå§‹ AST
    
    AST->>Transformer: 3. å¼€å§‹è½¬æ¢
    Note over Transformer: æ·±åº¦ä¼˜å…ˆéå†
    
    loop å¯¹æ¯ä¸ªèŠ‚ç‚¹
        Transformer->>Transformer: åº”ç”¨è½¬æ¢å‡½æ•°
        Note right of Transformer: transformElement<br/>transformText<br/>transformIf
    end
    
    Transformer->>JAST: 4. ç”Ÿæˆ JavaScript AST
    
    JAST->>Codegen: 5. å¼€å§‹ä»£ç ç”Ÿæˆ
    
    Note over Codegen: åˆ›å»ºä»£ç ä¸Šä¸‹æ–‡<br/>ç”Ÿæˆå‡½æ•°å£°æ˜<br/>å¤„ç†å¸®åŠ©å‡½æ•°
    
    loop é€’å½’å¤„ç†èŠ‚ç‚¹
        Codegen->>Codegen: ç”Ÿæˆå¯¹åº”ä»£ç ç‰‡æ®µ
    end
    
    Codegen->>Code: 6. è¾“å‡ºæ¸²æŸ“å‡½æ•°
    
    Note over Code: å¯æ‰§è¡Œçš„ JavaScript å‡½æ•°
```


## ä¸‰é˜¶æ®µç¼–è¯‘æµç¨‹

**è§£æï¼ˆParseï¼‰** â†’ **è½¬æ¢ï¼ˆTransformï¼‰** â†’ **ä»£ç ç”Ÿæˆï¼ˆCodegenï¼‰**

### 1. è§£æé˜¶æ®µï¼ˆParseï¼‰

è§£æé˜¶æ®µå°†æ¨¡æ¿å­—ç¬¦ä¸²è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚

#### æ ¸å¿ƒæ–‡ä»¶
- `parse.ts` - ä¸»è¦è§£æé€»è¾‘

#### å·¥ä½œåŸç†

1. **è¯æ³•åˆ†æï¼ˆTokenizationï¼‰**
   - å°†æ¨¡æ¿å­—ç¬¦ä¸²åˆ†è§£ä¸ºä¸€ç³»åˆ— token
   - è¯†åˆ«æ ‡ç­¾ã€æ–‡æœ¬ã€æ’å€¼è¡¨è¾¾å¼ã€æŒ‡ä»¤ç­‰

2. **è¯­æ³•åˆ†æï¼ˆParsingï¼‰**
   - åŸºäº token æ„å»º AST èŠ‚ç‚¹
   - å¤„ç†åµŒå¥—ç»“æ„å’ŒèŠ‚ç‚¹å…³ç³»

#### å·¥ä½œåŸç†
1. **è¯æ³•åˆ†æ**: å°†æ¨¡æ¿å­—ç¬¦ä¸²åˆ†è§£ä¸ºä¸€ç³»åˆ— token
2. **è¯­æ³•åˆ†æ**: åŸºäº token æ„å»º AST èŠ‚ç‚¹

#### æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹
```typescript
enum NodeTypes {
  ROOT,           // æ ¹èŠ‚ç‚¹
  ELEMENT,        // å…ƒç´ èŠ‚ç‚¹ <div>
  TEXT,           // æ–‡æœ¬èŠ‚ç‚¹
  COMMENT,        // æ³¨é‡ŠèŠ‚ç‚¹
  INTERPOLATION,  // æ’å€¼è¡¨è¾¾å¼ {{ }}
  DIRECTIVE,      // æŒ‡ä»¤ v-if, v-for
  ATTRIBUTE,      // å±æ€§
  // ... æ›´å¤šç±»å‹
}
```

#### è§£æç¤ºä¾‹
è¾“å…¥æ¨¡æ¿ï¼š
```html
<div id="app">{{ msg }}</div>
```

ç”Ÿæˆçš„ ASTï¼š
```javascript
{
  type: NodeTypes.ROOT,
  children: [{
    type: NodeTypes.ELEMENT,
    tag: 'div',
    props: [{
      type: NodeTypes.ATTRIBUTE,
      name: 'id',
      value: {
        type: NodeTypes.TEXT,
        content: 'app'
      }
    }],
    children: [{
      type: NodeTypes.INTERPOLATION,
      content: {
        type: NodeTypes.SIMPLE_EXPRESSION,
        content: 'msg'
      }
    }]
  }]
}
```

### 2. è½¬æ¢é˜¶æ®µï¼ˆTransformï¼‰

è½¬æ¢é˜¶æ®µå¯¹ AST è¿›è¡Œä¼˜åŒ–å’Œè½¬æ¢ï¼Œç”Ÿæˆ JavaScript ASTã€‚

#### æ ¸å¿ƒæ–‡ä»¶
- `transform.ts` - è½¬æ¢æ¡†æ¶
- `transforms/transformElement.ts` - å…ƒç´ è½¬æ¢
- `transforms/transformText.ts` - æ–‡æœ¬è½¬æ¢  
- `transforms/vIf.ts` - v-if æŒ‡ä»¤è½¬æ¢

#### æ ¸å¿ƒç‰¹ç‚¹
1. **æ·±åº¦ä¼˜å…ˆéå†**: ç¡®ä¿å­èŠ‚ç‚¹å…ˆäºçˆ¶èŠ‚ç‚¹å¤„ç†
2. **åŒé˜¶æ®µå¤„ç†**: è¿›å…¥é˜¶æ®µï¼ˆæ”¶é›†ï¼‰+ é€€å‡ºé˜¶æ®µï¼ˆæ‰§è¡Œï¼‰
3. **æ’ä»¶åŒ–è®¾è®¡**: æ¯ç§èŠ‚ç‚¹ç±»å‹æœ‰å¯¹åº”çš„è½¬æ¢å‡½æ•°

#### ä¸»è¦è½¬æ¢ç±»å‹

**å…ƒç´ è½¬æ¢ï¼ˆtransformElementï¼‰**
```javascript
// å°†å…ƒç´ èŠ‚ç‚¹è½¬æ¢ä¸º createElementVNode è°ƒç”¨
<div></div> 
â†“
createElementVNode("div", [], [])
```

**æ–‡æœ¬è½¬æ¢ï¼ˆtransformTextï¼‰**
```javascript
// åˆå¹¶ç›¸é‚»çš„æ–‡æœ¬å’Œæ’å€¼è¡¨è¾¾å¼
hello {{ msg }}
â†“
"hello " + toDisplayString(msg)
```

**æ¡ä»¶è½¬æ¢ï¼ˆtransformIfï¼‰**
```javascript
// å°† v-if è½¬æ¢ä¸ºæ¡ä»¶è¡¨è¾¾å¼
<h1 v-if="show">Title</h1>
â†“
show ? createElementVNode("h1", null, "Title") : createCommentVNode("v-if")
```

#### è½¬æ¢ä¸Šä¸‹æ–‡
```typescript
interface TransformContext {
  root: any                    // AST æ ¹èŠ‚ç‚¹
  parent: ParentNode | null    // çˆ¶èŠ‚ç‚¹
  currentNode: any             // å½“å‰å¤„ç†èŠ‚ç‚¹
  helpers: Map<symbol, number> // å¸®åŠ©å‡½æ•°æ˜ å°„
  nodeTransforms: any[]        // è½¬æ¢å‡½æ•°æ•°ç»„
}
```

### 3. ä»£ç ç”Ÿæˆé˜¶æ®µï¼ˆCodegenï¼‰

**ç›®æ ‡**ï¼šå°† JavaScript AST è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„æ¸²æŸ“å‡½æ•°ä»£ç 

#### æ ¸å¿ƒæ–‡ä»¶
- `codegen.ts` - ä»£ç ç”Ÿæˆé€»è¾‘

#### ç”Ÿæˆè¿‡ç¨‹
1. **åˆ›å»ºä»£ç ä¸Šä¸‹æ–‡**: ç®¡ç†ä»£ç å­—ç¬¦ä¸²ã€ç¼©è¿›ã€å¸®åŠ©å‡½æ•°ç­‰
2. **ç”Ÿæˆå‡½æ•°å‰å¯¼**: å¯¼å…¥å¿…è¦çš„å¸®åŠ©å‡½æ•°
3. **ç”Ÿæˆå‡½æ•°ä½“**: é€’å½’å¤„ç† JavaScript AST èŠ‚ç‚¹
4. **ä¼˜åŒ–è¾“å‡º**: å‹ç¼©å’Œæ ¼å¼åŒ–æœ€ç»ˆä»£ç 

#### ç”Ÿæˆç¤ºä¾‹
JavaScript AST è¾“å…¥ï¼š
```javascript
{
  type: NodeTypes.VNODE_CALL,
  tag: '"div"',
  children: [{ type: NodeTypes.TEXT, content: "hello" }]
}
```

ç”Ÿæˆçš„æ¸²æŸ“å‡½æ•°ï¼š
```javascript
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createElementVNode: _createElementVNode } = _Vue
    
    return _createElementVNode("div", null, ["hello"])
  }
}
```

## ğŸ”§ ä¸»è¦ API

### compiler-core

```typescript
// åŸºç¡€ç¼–è¯‘å‡½æ•°
export function baseCompile(template: string, options = {})

// å„é˜¶æ®µå‡½æ•°
export function baseParse(template: string)           // è§£æ
export function transform(ast: any, options: any)    // è½¬æ¢  
export function generate(ast: any)                   // ä»£ç ç”Ÿæˆ
```

### compiler-dom

```typescript
// DOM å¹³å°ç¼–è¯‘å‡½æ•°
export function compile(template: string, options?: any)
```

## æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥

### 1. é™æ€æå‡ï¼ˆStatic Hoistingï¼‰
è¯†åˆ«é™æ€å†…å®¹ï¼Œé¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶é‡å¤åˆ›å»ºã€‚

```javascript
// æ¨¡æ¿
<div>
  <p>static text</p>
  <p>{{ dynamic }}</p>
</div>

// ç¼–è¯‘å
const _hoisted_1 = /*#__PURE__*/createElementVNode("p", null, "static text", -1)

export function render(_ctx, _cache) {
  return (openBlock(), createElementBlock("div", null, [
    _hoisted_1,
    createElementVNode("p", null, toDisplayString(_ctx.dynamic), 1)
  ]))
}
```

### 2. é¢„å­—ç¬¦ä¸²åŒ–ï¼ˆPre-stringificationï¼‰
å°†è¿ç»­çš„é™æ€èŠ‚ç‚¹é¢„å…ˆè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå‡å°‘åˆ›å»ºçš„ VNode æ•°é‡ã€‚

### 3. ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°
å¯¹å†…è”äº‹ä»¶å¤„ç†å‡½æ•°è¿›è¡Œç¼“å­˜ï¼Œé¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶åˆ›å»ºæ–°å‡½æ•°ã€‚

```javascript
// æ¨¡æ¿
<button @click="count++">Count: {{ count }}</button>

// ç¼–è¯‘å
export function render(_ctx, _cache) {
  return (openBlock(), createElementBlock("button", {
    onClick: _cache[0] || (_cache[0] = $event => (_ctx.count++))
  }, "Count: " + toDisplayString(_ctx.count), 1))
}
```

## æŒ‡ä»¤ç¼–è¯‘

Vue3 ç¼–è¯‘å™¨å¯¹å„ç§æŒ‡ä»¤è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼š

### v-if / v-else-if / v-else
è½¬æ¢ä¸ºæ¡ä»¶è¡¨è¾¾å¼ï¼š
```javascript
{
  type: NodeTypes.IF,
  branches: [
    { condition: 'show', children: [/* vnode */] },
    { condition: 'other', children: [/* vnode */] },
    { condition: undefined, children: [/* vnode */] }
  ]
}
```

### v-for
è½¬æ¢ä¸ºæ¸²æŸ“å‡½æ•°è°ƒç”¨ï¼š
```javascript
// æ¨¡æ¿
<li v-for="item in items">{{ item }}</li>

// ç¼–è¯‘å
renderList(_ctx.items, (item) => {
  return createElementVNode("li", null, toDisplayString(item), 1)
})
```

### v-bind
å¤„ç†åŠ¨æ€å±æ€§ç»‘å®šï¼š
```javascript
// æ¨¡æ¿
<div :[key]="value" :class="cls"></div>

// ç¼–è¯‘å
createElementVNode("div", {
  [key]: value,
  class: cls
})
```

## é”™è¯¯å¤„ç†ä¸è°ƒè¯•

### ä½ç½®ä¿¡æ¯è·Ÿè¸ª
ç¼–è¯‘å™¨ä¼šè·Ÿè¸ªæ¯ä¸ªèŠ‚ç‚¹åœ¨æºç ä¸­çš„ä½ç½®ä¿¡æ¯ï¼Œä¾¿äºå®šä½é”™è¯¯ã€‚

### æ¸è¿›å¼è§£æ
å°½å¯èƒ½è§£ææœ‰æ•ˆéƒ¨åˆ†ï¼Œå³ä½¿é‡åˆ°é”™è¯¯ä¹Ÿèƒ½ç”Ÿæˆéƒ¨åˆ†æœ‰æ•ˆçš„ä»£ç ã€‚

### è°ƒè¯•æŠ€å·§
```javascript
// æŸ¥çœ‹ AST
import { baseParse } from 'vue/compiler-core'
const ast = baseParse('<div>{{ msg }}</div>')
console.log(JSON.stringify(ast, null, 2))

// æŸ¥çœ‹ç¼–è¯‘ç»“æœ
import { compile } from 'vue/compiler-core'
const result = compile('<div>{{ msg }}</div>')
console.log('Generated code:', result.code)
```

## å¹³å°é€‚é…

Vue3 ç¼–è¯‘å™¨é€šè¿‡å¹³å°ç‰¹å®šçš„æ‰©å±•æ¥é€‚é…ä¸åŒå¹³å°ï¼š

```javascript
// DOM å¹³å°ç¼–è¯‘å™¨
import { baseCompile } from 'compiler-core'
import { parserOptions } from 'compiler-dom'

export function compile(template, options) {
  return baseCompile(template, {
    ...options,
    ...parserOptions,
    // å¹³å°ç‰¹å®šé…ç½®
  })
}
```

## æ€»ç»“

Vue3 ç¼–è¯‘å™¨é€šè¿‡ä¸‰é˜¶æ®µç¼–è¯‘æµç¨‹ï¼Œå°†æ¨¡æ¿é«˜æ•ˆåœ°è½¬æ¢ä¸ºæ¸²æŸ“å‡½æ•°ã€‚å…¶æ¨¡å—åŒ–è®¾è®¡å’Œä¸°å¯Œçš„ä¼˜åŒ–ç­–ç•¥ä½¿å¾—ç¼–è¯‘åçš„ä»£ç å…·æœ‰ä¼˜å¼‚çš„æ€§èƒ½ã€‚ç†è§£ç¼–è¯‘å™¨çš„å·¥ä½œåŸç†æœ‰åŠ©äºå¼€å‘è€…ç¼–å†™æ›´é«˜æ•ˆçš„æ¨¡æ¿ï¼Œä¹Ÿèƒ½åœ¨é‡åˆ°ç¼–è¯‘é—®é¢˜æ—¶å¿«é€Ÿå®šä½å’Œè§£å†³ã€‚