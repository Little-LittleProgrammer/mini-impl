# è¿è¡Œæ—¶æ ¸å¿ƒï¼ˆruntime-coreï¼‰

`runtime-core` æ¨¡å—æ˜¯ mini-vue çš„è¿è¡Œæ—¶æ ¸å¿ƒï¼Œè´Ÿè´£è™šæ‹Ÿ DOMã€ç»„ä»¶ç³»ç»Ÿã€æ¸²æŸ“å™¨ç­‰çš„å®ç°ã€‚

## ä¸»è¦å†…å®¹

- **è™šæ‹Ÿ DOMï¼ˆVNodeï¼‰**ï¼šé€šè¿‡ vnode.ts å®šä¹‰è™šæ‹ŸèŠ‚ç‚¹ç»“æ„ï¼Œå®ç°é«˜æ•ˆçš„ DOM diffã€‚
- **ç»„ä»¶ç³»ç»Ÿ**ï¼šcomponent.ts å®ç°ç»„ä»¶çš„åˆ›å»ºã€æŒ‚è½½ã€æ›´æ–°å’Œå¸è½½ã€‚
- **æ¸²æŸ“å™¨ï¼ˆrendererï¼‰**ï¼šrenderer.ts å®ç°å¹³å°æ— å…³çš„æ¸²æŸ“é€»è¾‘ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¸²æŸ“ç›®æ ‡ã€‚
- **è°ƒåº¦ä¸å‰¯ä½œç”¨**ï¼šscheduler.ts ç®¡ç†å‰¯ä½œç”¨ä»»åŠ¡çš„è°ƒåº¦ã€‚

## ä¸»è¦ API

- `h(type, props, children)`ï¼šåˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹ã€‚
- `createRenderer(options)`ï¼šåˆ›å»ºè‡ªå®šä¹‰æ¸²æŸ“å™¨ã€‚
- `render(vnode, container)`ï¼šæ¸²æŸ“è™šæ‹ŸèŠ‚ç‚¹åˆ°å®¹å™¨ã€‚

## ç¤ºä¾‹

```js
import { h, render } from 'mini-vue/runtime-core'

const vnode = h('div', { id: 'app' }, 'Hello mini-vue')
render(vnode, document.getElementById('root'))
```

æ›´å¤šè¿è¡Œæ—¶ç›¸å…³ç¤ºä¾‹å¯å‚è€ƒ `packages/vue/src/examples/runtime/` ç›®å½•ã€‚ 


## Vue3 Diffç®—æ³•æµç¨‹è§£æ

### ğŸ¯ ç®—æ³•æ€»ä½“æ€è·¯
Vue3çš„diffç®—æ³•é‡‡ç”¨äº†**åŒç«¯æ¯”è¾ƒ + æœ€é•¿é€’å¢å­åºåˆ—**çš„ç­–ç•¥ï¼Œå°†å¤æ‚åº¦ä»O(nÂ³)ä¼˜åŒ–åˆ°O(n log n)ã€‚

### ğŸ“‹ äº”å¤§æ ¸å¿ƒæ­¥éª¤

#### **æ­¥éª¤1: è‡ªå‰å‘åå¯¹æ¯”**
- ä»æ•°ç»„å¼€å¤´å¼€å§‹ï¼Œé€ä¸€å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹
- ç›¸åŒç±»å‹çš„èŠ‚ç‚¹ç›´æ¥patchæ›´æ–°
- é‡åˆ°ä¸åŒç±»å‹ç«‹å³è·³å‡ºå¾ªç¯

#### **æ­¥éª¤2: è‡ªåå‘å‰å¯¹æ¯”**  
- ä»æ•°ç»„æœ«å°¾å¼€å§‹ï¼Œé€ä¸€å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹
- ç»§ç»­å¤„ç†ç›¸åŒç±»å‹çš„èŠ‚ç‚¹
- è¿™ä¸¤æ­¥å¯ä»¥å¿«é€Ÿå¤„ç†å¤§å¤šæ•°å¸¸è§åœºæ™¯

#### **æ­¥éª¤3: æ–°èŠ‚ç‚¹å¤šäºæ—§èŠ‚ç‚¹**
- å¦‚æœ`i > oldChildrenEnd`ï¼Œè¯´æ˜è¿˜æœ‰æ–°èŠ‚ç‚¹éœ€è¦æŒ‚è½½
- ç¡®å®šæ­£ç¡®çš„æ’å…¥ä½ç½®ï¼ˆé”šç‚¹ï¼‰
- æŒ‚è½½æ‰€æœ‰å‰©ä½™çš„æ–°èŠ‚ç‚¹

#### **æ­¥éª¤4: æ—§èŠ‚ç‚¹å¤šäºæ–°èŠ‚ç‚¹**
- å¦‚æœ`i > newChildrenEnd`ï¼Œè¯´æ˜è¿˜æœ‰æ—§èŠ‚ç‚¹éœ€è¦åˆ é™¤
- å¸è½½æ‰€æœ‰å‰©ä½™çš„æ—§èŠ‚ç‚¹

#### **æ­¥éª¤5: ä¹±åºæƒ…å†µï¼ˆæœ€å¤æ‚ï¼‰**
è¿™æ˜¯ç®—æ³•çš„ç²¾åéƒ¨åˆ†ï¼Œåˆ†ä¸ºä¸‰ä¸ªå­æ­¥éª¤ï¼š

**5.1 å»ºç«‹æ˜ å°„å…³ç³»**
- åˆ›å»º`keyToNewIndexMap`ï¼škey â†’ æ–°æ•°ç»„ç´¢å¼•çš„æ˜ å°„
- è¿™å°±æ˜¯ä¸ºä»€ä¹ˆv-foréœ€è¦keyçš„åŸå› ï¼

**5.2 å¤„ç†æ—§èŠ‚ç‚¹**
- éå†æ‰€æœ‰æ—§èŠ‚ç‚¹ï¼Œå°è¯•åœ¨æ–°æ•°ç»„ä¸­æ‰¾åˆ°å¯¹åº”ä½ç½®
- å»ºç«‹`newIndexToOldIndexMap`ï¼šæ–°ç´¢å¼• â†’ æ—§ç´¢å¼•çš„æ˜ å°„
- åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨ï¼ˆé€šè¿‡æœ€å¤§ç´¢å¼•å€¼é€’å¢åˆ¤æ–­ï¼‰

**5.3 æœ€å°åŒ–ç§»åŠ¨æ“ä½œ**
- ä½¿ç”¨**æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•**æ‰¾å‡ºä¸éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹
- åªç§»åŠ¨ä¸åœ¨å­åºåˆ—ä¸­çš„èŠ‚ç‚¹ï¼Œå¤§å¤§å‡å°‘DOMæ“ä½œ

### ğŸš€ ç®—æ³•ä¼˜åŠ¿

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡åŒç«¯æ¯”è¾ƒå¿«é€Ÿå¤„ç†å¸¸è§åœºæ™¯
2. **ç§»åŠ¨æœ€å°åŒ–**ï¼šæœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•æœ€å°åŒ–DOMç§»åŠ¨
3. **å†…å­˜å‹å¥½**ï¼šä½¿ç”¨ç´¢å¼•æ˜ å°„è€Œéç›´æ¥æ“ä½œDOM
4. **ç¨³å®šæ€§é«˜**ï¼šå¯¹å„ç§è¾¹ç•Œæƒ…å†µéƒ½æœ‰å®Œå–„å¤„ç†

### æµç¨‹å›¾

```mermaid
flowchart TD
    A[å¼€å§‹ patchKeyedChildren] --> B[åˆå§‹åŒ–ç´¢å¼•å˜é‡<br/>i=0, oldChildrenEnd, newChildrenEnd]
    
    B --> C[æ­¥éª¤1: è‡ªå‰å‘åå¯¹æ¯”]
    C --> D{i &lt;= oldChildrenEnd <br/>&&<br/> i &lt;= newChildrenEnd?}
    D -->|æ˜¯| E{isSameVNodeType?}
    E -->|æ˜¯| F[patchå¯¹åº”èŠ‚ç‚¹<br/>i++]
    F --> D
    E -->|å¦| G[è·³å‡ºå¾ªç¯]
    D -->|å¦| G
    
    G --> H[æ­¥éª¤2: è‡ªåå‘å‰å¯¹æ¯”]
    H --> I{i &lt;= oldChildrenEnd <br/>&&<br/> i &lt;= newChildrenEnd?}
    I -->|æ˜¯| J{isSameVNodeType?}
    J -->|æ˜¯| K[patchå¯¹åº”èŠ‚ç‚¹<br/>oldChildrenEnd--, newChildrenEnd--]
    K --> I
    J -->|å¦| L[è·³å‡ºå¾ªç¯]
    I -->|å¦| L
    
    L --> M{i &gt; oldChildrenEnd?}
    M -->|æ˜¯| N[æ­¥éª¤3: æ–°èŠ‚ç‚¹å¤šäºæ—§èŠ‚ç‚¹]
    N --> O[æŒ‚è½½å‰©ä½™æ–°èŠ‚ç‚¹]
    O --> END[ç»“æŸ]
    
    M -->|å¦| P{i &gt; newChildrenEnd?}
    P -->|æ˜¯| Q[æ­¥éª¤4: æ—§èŠ‚ç‚¹å¤šäºæ–°èŠ‚ç‚¹]
    Q --> R[å¸è½½å‰©ä½™æ—§èŠ‚ç‚¹]
    R --> END
    
    P -->|å¦| S[æ­¥éª¤5: ä¹±åºæƒ…å†µå¤„ç†]
    
    S --> T[5.1 åˆ›å»ºkeyToNewIndexMap<br/>keyæ˜ å°„åˆ°newIndex]
    T --> U[5.2 éå†æ—§èŠ‚ç‚¹å¤„ç†]
    U --> V[åˆ›å»ºnewIndexToOldIndexMap<br/>å»ºç«‹æ–°æ—§ç´¢å¼•æ˜ å°„]
    V --> W{æ—§èŠ‚ç‚¹åœ¨æ–°æ•°ç»„ä¸­å­˜åœ¨?}
    W -->|å¦| X[unmountæ—§èŠ‚ç‚¹]
    W -->|æ˜¯| Y[patchèŠ‚ç‚¹<br/>åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨]
    X --> Z{è¿˜æœ‰æ—§èŠ‚ç‚¹?}
    Y --> Z
    Z -->|æ˜¯| W
    Z -->|å¦| AA[5.3 å¤„ç†ç§»åŠ¨å’Œæ–°å¢]
    
    AA --> BB{moved == true?}
    BB -->|æ˜¯| CC[è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ—<br/>getSequence]
    BB -->|å¦| DD[ä»åå‘å‰éå†å¤„ç†]
    CC --> DD
    
    DD --> EE{æ˜ å°„å€¼ä¸º0?}
    EE -->|æ˜¯| FF[patchæ–°å¢èŠ‚ç‚¹]
    EE -->|å¦| GG{éœ€è¦ç§»åŠ¨?}
    GG -->|æ˜¯| HH[moveèŠ‚ç‚¹åˆ°æ­£ç¡®ä½ç½®]
    GG -->|å¦| II[ä¿æŒåŸä½ç½®]
    
    FF --> JJ{è¿˜æœ‰èŠ‚ç‚¹éœ€è¦å¤„ç†?}
    HH --> JJ
    II --> JJ
    JJ -->|æ˜¯| EE
    JJ -->|å¦| END
    
    style A fill:#e1f5fe
    style END fill:#c8e6c9
    style S fill:#fff3e0
    style CC fill:#fce4ec
```