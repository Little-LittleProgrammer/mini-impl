# ä»£ç ç”Ÿæˆå™¨ï¼ˆCodegenï¼‰

ä»£ç ç”Ÿæˆå™¨æ˜¯ Vue ç¼–è¯‘å™¨çš„ç¬¬ä¸‰é˜¶æ®µï¼Œè´Ÿè´£å°†ç»è¿‡è½¬æ¢çš„ JavaScript AST è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„æ¸²æŸ“å‡½æ•°ä»£ç å­—ç¬¦ä¸²ã€‚

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

å°†ç»“æ„åŒ–çš„ JavaScript AST è½¬æ¢ä¸ºï¼š
- å¯æ‰§è¡Œçš„ JavaScript æ¸²æŸ“å‡½æ•°ä»£ç 
- ä¼˜åŒ–çš„ä»£ç ç»“æ„ï¼ˆåŒ…å«å¿…è¦çš„å¸®åŠ©å‡½æ•°å¯¼å…¥ï¼‰
- æ­£ç¡®çš„ä»£ç æ ¼å¼ï¼ˆç¼©è¿›ã€æ¢è¡Œç­‰ï¼‰

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ–‡ä»¶ç»“æ„
```
packages/compiler-core/src/
â”œâ”€â”€ codegen.ts          # æ ¸å¿ƒä»£ç ç”Ÿæˆé€»è¾‘
â”œâ”€â”€ runtimeHelpers.ts   # è¿è¡Œæ—¶å¸®åŠ©å‡½æ•°å®šä¹‰
â””â”€â”€ utils.ts           # ä»£ç ç”Ÿæˆå·¥å…·å‡½æ•°
```

### æ ¸å¿ƒç»„ä»¶

1. **ä»£ç ç”Ÿæˆä¸Šä¸‹æ–‡ï¼ˆCodegenContextï¼‰** - ç®¡ç†ä»£ç ç”Ÿæˆè¿‡ç¨‹ä¸­çš„çŠ¶æ€
2. **èŠ‚ç‚¹å¤„ç†å™¨ï¼ˆNode Handlersï¼‰** - å¤„ç†ä¸åŒç±»å‹çš„ AST èŠ‚ç‚¹
3. **ä»£ç æ ¼å¼åŒ–å·¥å…·** - å¤„ç†ç¼©è¿›ã€æ¢è¡Œã€å‚æ•°åˆ—è¡¨ç­‰

## ğŸ“‹ ä»£ç ç”Ÿæˆä¸Šä¸‹æ–‡

### CodegenContext æ¥å£

```typescript
interface CodegenContext {
  code: string                    // å½“å‰ç”Ÿæˆçš„ä»£ç å­—ç¬¦ä¸²
  runtimeGlobalName: string      // è¿è¡Œæ—¶å…¨å±€å˜é‡åï¼ˆé€šå¸¸ä¸º 'Vue'ï¼‰
  source: string                 // åŸå§‹æ¨¡æ¿æºç 
  indentLevel: number            // å½“å‰ç¼©è¿›çº§åˆ«
  
  // æ ¸å¿ƒæ–¹æ³•
  helper(key: symbol): string    // è·å–å¸®åŠ©å‡½æ•°åç§°
  push(code: string): void       // è¿½åŠ ä»£ç 
  newline(): void               // æ·»åŠ æ¢è¡Œ
  indent(): void                // å¢åŠ ç¼©è¿›å¹¶æ¢è¡Œ
  deindent(): void              // å‡å°‘ç¼©è¿›å¹¶æ¢è¡Œ
}
```

### ä¸Šä¸‹æ–‡åˆ›å»ºè¿‡ç¨‹

```javascript
function createCodegenContext(ast) {
  const context = {
    code: ``,                    // åˆå§‹åŒ–ä¸ºç©ºå­—ç¬¦ä¸²
    runtimeGlobalName: 'Vue',    // é»˜è®¤è¿è¡Œæ—¶åç§°
    source: ast.loc.source,      // ä¿å­˜åŸå§‹æ¨¡æ¿
    indentLevel: 0,              // åˆå§‹ç¼©è¿›ä¸º 0
    
    // è·å–å¸®åŠ©å‡½æ•°åç§°ï¼šCREATE_ELEMENT_VNODE -> '_createElementVNode'
    helper(key) {
      return `_${helperNameMap[key]}`
    },
    
    // è¿½åŠ ä»£ç åˆ° code å­—ç¬¦ä¸²
    push(code) {
      context.code += code
    },
    
    // æ¢è¡Œå¹¶åº”ç”¨å½“å‰ç¼©è¿›çº§åˆ«
    newline() {
      newline(context.indentLevel)
    },
    
    // å¢åŠ ç¼©è¿›çº§åˆ«å¹¶æ¢è¡Œ
    indent() {
      newline(++context.indentLevel)
    },
    
    // å‡å°‘ç¼©è¿›çº§åˆ«å¹¶æ¢è¡Œ
    deindent() {
      newline(--context.indentLevel)
    }
  }
  
  // å†…éƒ¨æ¢è¡Œå‡½æ•°ï¼šæ·»åŠ æ¢è¡Œç¬¦å’Œå¯¹åº”æ•°é‡çš„ç©ºæ ¼
  function newline(n: number) {
    context.code += '\n' + `  `.repeat(n)
  }
  
  return context
}
```

## ğŸ”„ ä»£ç ç”Ÿæˆæµç¨‹

### ä¸»å‡½æ•°ï¼šgenerate()

```javascript
export function generate(ast) {
  // 1. åˆ›å»ºä»£ç ç”Ÿæˆä¸Šä¸‹æ–‡
  const context = createCodegenContext(ast)
  const { push, newline, indent, deindent } = context

  // 2. ç”Ÿæˆå‡½æ•°å‰å¯¼ä»£ç 
  genFunctionPreamble(context)
  
  // 3. ç”Ÿæˆå‡½æ•°å£°æ˜
  const functionName = `render`
  const args = ['_ctx', '_cache']
  const signature = args.join(', ')
  push(`function ${functionName}(${signature}) {`)
  
  // 4. å‡½æ•°ä½“å¼€å§‹
  indent()
  push(`with (_ctx) {`)
  indent()
  
  // 5. å¯¼å…¥å¿…è¦çš„å¸®åŠ©å‡½æ•°
  const hasHelpers = ast.helpers.length > 0
  if (hasHelpers) {
    push(`const { ${ast.helpers.map(aliasHelper).join(', ')} } = _Vue`)
    push(`\n`)
    newline()
  }
  
  // 6. ç”Ÿæˆè¿”å›è¯­å¥
  newline()
  push(`return `)
  
  // 7. å¤„ç†æ ¹èŠ‚ç‚¹çš„ä»£ç ç”Ÿæˆ
  if (ast.codegenNode) {
    genNode(ast.codegenNode, context)
  } else {
    push(`null`)
  }
  
  // 8. å‡½æ•°ä½“ç»“æŸ
  deindent()
  push(`}`)
  deindent()
  push(`}`)
  
  return {
    ast,
    code: context.code
  }
}
```

### å‡½æ•°å‰å¯¼ç”Ÿæˆ

```javascript
function genFunctionPreamble(context) {
  const { push, newline, runtimeGlobalName } = context
  
  // ç”Ÿæˆï¼šconst _Vue = Vue
  const VueBinding = runtimeGlobalName
  push(`const _Vue = ${VueBinding}\n`)
  
  newline()
  push(`return `)
}
```

### å¸®åŠ©å‡½æ•°åˆ«åç”Ÿæˆ

```javascript
// å°† Symbol è½¬æ¢ä¸ºå¯¼å…¥åˆ«å
// CREATE_ELEMENT_VNODE -> "createElementVNode: _createElementVNode"
const aliasHelper = (s: symbol) => `${helperNameMap[s]}: _${helperNameMap[s]}`
```

## ğŸ¯ èŠ‚ç‚¹å¤„ç†å™¨

### ä¸»èŠ‚ç‚¹åˆ†å‘å™¨ï¼šgenNode()

```javascript
function genNode(node, context) {
  switch (node.type) {
    case NodeTypes.ELEMENT:
    case NodeTypes.IF:
      // å…ƒç´ å’Œæ¡ä»¶èŠ‚ç‚¹ï¼šå¤„ç†å…¶ codegenNode
      genNode(node.codegenNode!, context)
      break
      
    case NodeTypes.VNODE_CALL:
      // VNode è°ƒç”¨ï¼šç”Ÿæˆ createElementVNode ç­‰å‡½æ•°è°ƒç”¨
      genVNodeCall(node, context)
      break
      
    case NodeTypes.TEXT:
      // æ–‡æœ¬èŠ‚ç‚¹ï¼šç”Ÿæˆ JSON.stringify(text)
      genText(node, context)
      break
      
    case NodeTypes.SIMPLE_EXPRESSION:
      // ç®€å•è¡¨è¾¾å¼ï¼šç”Ÿæˆå˜é‡æˆ–å­—é¢é‡
      genExpression(node, context)
      break
      
    case NodeTypes.INTERPOLATION:
      // æ’å€¼è¡¨è¾¾å¼ï¼šç”Ÿæˆ toDisplayString() è°ƒç”¨
      genInterpolation(node, context)
      break
      
    case NodeTypes.COMPOUND_EXPRESSION:
      // å¤åˆè¡¨è¾¾å¼ï¼šå¤„ç†æ–‡æœ¬å’Œæ’å€¼çš„ç»„åˆ
      genCompoundExpression(node, context)
      break
      
    case NodeTypes.JS_CALL_EXPRESSION:
      // JavaScript å‡½æ•°è°ƒç”¨
      genCallExpression(node, context)
      break
      
    case NodeTypes.JS_CONDITIONAL_EXPRESSION:
      // JavaScript æ¡ä»¶è¡¨è¾¾å¼ï¼ˆä¸‰å…ƒè¿ç®—ç¬¦ï¼‰
      genConditionalExpression(node, context)
      break
  }
}
```

### VNode è°ƒç”¨ç”Ÿæˆï¼šgenVNodeCall()

è¿™æ˜¯æœ€é‡è¦çš„èŠ‚ç‚¹å¤„ç†å™¨ï¼Œè´Ÿè´£ç”Ÿæˆ `createElementVNode` ç­‰å‡½æ•°è°ƒç”¨ï¼š

```javascript
function genVNodeCall(node, context) {
  const { push, helper } = context
  const { tag, props, children, patchFlag, dynamicProps, isComponent } = node

  // 1. ç¡®å®šè°ƒç”¨çš„å¸®åŠ©å‡½æ•°
  const callHelper = getVNodeHelper(context.inSSR, isComponent)
  push(helper(callHelper) + `(`, node)

  // 2. å‡†å¤‡å‡½æ•°å‚æ•°
  const args = genNullableArgs([tag, props, children, patchFlag, dynamicProps])

  // 3. ç”Ÿæˆå‚æ•°åˆ—è¡¨
  genNodeList(args, context)

  push(`)`)
}
```

**ç”Ÿæˆç¤ºä¾‹ï¼š**
```javascript
// è¾“å…¥èŠ‚ç‚¹ï¼š
{
  type: NodeTypes.VNODE_CALL,
  tag: '"div"',
  props: null,
  children: [{ type: NodeTypes.TEXT, content: "hello" }]
}

// ç”Ÿæˆä»£ç ï¼š
_createElementVNode("div", null, ["hello"])
```

### æ¡ä»¶è¡¨è¾¾å¼ç”Ÿæˆï¼šgenConditionalExpression()

å¤„ç† v-if æŒ‡ä»¤è½¬æ¢åçš„æ¡ä»¶è¡¨è¾¾å¼ï¼š

```javascript
function genConditionalExpression(node, context) {
  const { test, consequent, alternate, newline: needNewline } = node
  const { push, indent, deindent, newline } = context
  
  // 1. ç”Ÿæˆæµ‹è¯•æ¡ä»¶
  if (test.type === NodeTypes.SIMPLE_EXPRESSION) {
    genExpression(test, context)
  }
  
  // 2. å¤„ç†æ ¼å¼å’Œç¼©è¿›
  needNewline && indent()
  context.indentLevel++
  needNewline || push(` `)
  
  // 3. ç”Ÿæˆæ¡ä»¶è¿ç®—ç¬¦å’Œç»“æœ
  push(`? `)
  genNode(consequent, context)
  
  context.indentLevel--
  needNewline && newline()
  needNewline || push(` `)
  
  push(`: `)
  
  // 4. å¤„ç†åµŒå¥—æ¡ä»¶ï¼ˆelse ifï¼‰
  const isNested = alternate.type === NodeTypes.JS_CONDITIONAL_EXPRESSION
  if (!isNested) {
    context.indentLevel++
  }
  
  // 5. ç”Ÿæˆ else åˆ†æ”¯
  genNode(alternate, context)
  
  if (!isNested) {
    context.indentLevel--
  }
  
  needNewline && deindent()
}
```

**ç”Ÿæˆç¤ºä¾‹ï¼š**
```javascript
// v-if="show" v-else-if="loading" v-else
// ç”Ÿæˆï¼š
show
  ? _createElementVNode("h1", null, "Title")
  : loading
    ? _createElementVNode("div", null, "Loading...")
    : _createCommentVNode("v-if", true)
```

### å¤åˆè¡¨è¾¾å¼ç”Ÿæˆï¼šgenCompoundExpression()

å¤„ç†æ–‡æœ¬å’Œæ’å€¼è¡¨è¾¾å¼çš„ç»„åˆï¼š

```javascript
function genCompoundExpression(node, context) {
  for (let i = 0; i < node.children!.length; i++) {
    const child = node.children![i]
    if (isString(child)) {
      // å­—ç¬¦ä¸²ç›´æ¥è¿½åŠ 
      context.push(child)
    } else {
      // è¡¨è¾¾å¼é€’å½’å¤„ç†
      genNode(child, context)
    }
  }
}
```

**ç”Ÿæˆç¤ºä¾‹ï¼š**
```javascript
// æ¨¡æ¿ï¼šHello {{ name }}!
// è½¬æ¢åçš„å¤åˆè¡¨è¾¾å¼ï¼š
{
  type: NodeTypes.COMPOUND_EXPRESSION,
  children: [
    '"Hello "',  // å­—ç¬¦ä¸²
    { type: NodeTypes.INTERPOLATION, content: { content: 'name' } },  // æ’å€¼
    '"!"'        // å­—ç¬¦ä¸²
  ]
}

// ç”Ÿæˆä»£ç ï¼š
"Hello " + _toDisplayString(name) + "!"
```

### æ’å€¼è¡¨è¾¾å¼ç”Ÿæˆï¼šgenInterpolation()

```javascript
function genInterpolation(node, context) {
  const { push, helper } = context
  push(`${helper(TO_DISPLAY_STRING)}(`)
  genNode(node.content, context)
  push(`)`)
}
```

**ç”Ÿæˆç¤ºä¾‹ï¼š**
```javascript
// {{ message }}
// ç”Ÿæˆï¼š
_toDisplayString(message)
```

### æ–‡æœ¬èŠ‚ç‚¹ç”Ÿæˆï¼šgenText()

```javascript
function genText(node, context) {
  context.push(JSON.stringify(node.content), node)
}
```

**ç”Ÿæˆç¤ºä¾‹ï¼š**
```javascript
// æ–‡æœ¬ï¼šhello world
// ç”Ÿæˆï¼š
"hello world"
```

### ç®€å•è¡¨è¾¾å¼ç”Ÿæˆï¼šgenExpression()

```javascript
function genExpression(node, context) {
  const { content, isStatic } = node
  // é™æ€å€¼ç”¨ JSON.stringifyï¼ŒåŠ¨æ€å€¼ç›´æ¥ä½¿ç”¨
  context.push(isStatic ? JSON.stringify(content) : content, node)
}
```

## ğŸ› ï¸ å·¥å…·å‡½æ•°

### å‚æ•°åˆ—è¡¨ç”Ÿæˆï¼šgenNodeList()

```javascript
function genNodeList(nodes, context) {
  const { push } = context
  for (let i = 0; i < nodes.length; i++) {
    const node = nodes[i]
    
    if (isString(node)) {
      // å­—ç¬¦ä¸²ç›´æ¥æ·»åŠ 
      push(node)
    } else if (isArray(node)) {
      // æ•°ç»„éœ€è¦åŒ…è£…åœ¨ [] ä¸­
      genNodeListAsArray(node, context)
    } else {
      // å¯¹è±¡é€’å½’å¤„ç†
      genNode(node, context)
    }
    
    // æ·»åŠ é€—å·åˆ†éš”ç¬¦ï¼ˆé™¤äº†æœ€åä¸€ä¸ªï¼‰
    if (i < nodes.length - 1) {
      push(', ')
    }
  }
}
```

### æ•°ç»„å‚æ•°ç”Ÿæˆï¼šgenNodeListAsArray()

```javascript
function genNodeListAsArray(nodes, context) {
  context.push(`[`)
  genNodeList(nodes, context)
  context.push(`]`)
}
```

### å‚æ•°ä¼˜åŒ–ï¼šgenNullableArgs()

ç§»é™¤å‡½æ•°è°ƒç”¨æœ«å°¾çš„ null å‚æ•°ä»¥ä¼˜åŒ–ä»£ç ï¼š

```javascript
function genNullableArgs(args: any[]) {
  let i = args.length
  // ä»åå¾€å‰æ‰¾åˆ°ç¬¬ä¸€ä¸ªé null å‚æ•°
  while (i--) {
    if (args[i] != null) break
  }
  // è¿”å›åˆ°è¯¥å‚æ•°ä¸ºæ­¢çš„æ‰€æœ‰å‚æ•°ï¼Œnull è½¬ä¸º "null" å­—ç¬¦ä¸²
  return args.slice(0, i + 1).map(arg => arg || `null`)
}
```

**ä¼˜åŒ–ç¤ºä¾‹ï¼š**
```javascript
// ä¼˜åŒ–å‰ï¼šcreateElementVNode("div", null, null, null, null)
// ä¼˜åŒ–åï¼šcreateElementVNode("div")
```

## ğŸ¨ è¿è¡Œæ—¶å¸®åŠ©å‡½æ•°

### å¸®åŠ©å‡½æ•°æ˜ å°„

```javascript
// runtimeHelpers.ts
export const CREATE_ELEMENT_VNODE = Symbol('createElementVNode')
export const CREATE_VNODE = Symbol('createVNode')
export const TO_DISPLAY_STRING = Symbol('toDisplayString')
export const CREATE_COMMENT = Symbol('createCommentVNode')

export const helperNameMap = {
  [CREATE_ELEMENT_VNODE]: 'createElementVNode',
  [CREATE_VNODE]: 'createVNode', 
  [TO_DISPLAY_STRING]: 'toDisplayString',
  [CREATE_COMMENT]: 'createCommentVNode'
}
```

### å¸®åŠ©å‡½æ•°å¯¼å…¥ç”Ÿæˆ

```javascript
// ç”Ÿæˆï¼šconst { createElementVNode: _createElementVNode, toDisplayString: _toDisplayString } = _Vue
const hasHelpers = ast.helpers.length > 0
if (hasHelpers) {
  push(`const { ${ast.helpers.map(aliasHelper).join(', ')} } = _Vue`)
}
```

## ğŸ“ å®Œæ•´ç”Ÿæˆç¤ºä¾‹

### è¾“å…¥æ¨¡æ¿
```html
<div class="container">
  <h1 v-if="title">{{ title }}</h1>
  <p>Hello {{ name }}!</p>
</div>
```

### ç”Ÿæˆçš„æ¸²æŸ“å‡½æ•°
```javascript
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { 
      createElementVNode: _createElementVNode, 
      toDisplayString: _toDisplayString,
      createCommentVNode: _createCommentVNode 
    } = _Vue

    return _createElementVNode("div", { class: "container" }, [
      title
        ? _createElementVNode("h1", null, _toDisplayString(title))
        : _createCommentVNode("v-if", true),
      _createElementVNode("p", null, "Hello " + _toDisplayString(name) + "!")
    ])
  }
}
```

## ğŸ”§ ä»£ç ç”Ÿæˆä¼˜åŒ–

### 1. é™æ€æå‡
- å°†é™æ€å†…å®¹æå‡åˆ°æ¸²æŸ“å‡½æ•°å¤–éƒ¨
- é¿å…æ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°åˆ›å»ºé™æ€ VNode

### 2. å†…è”ç»„ä»¶ Props
- å°†ç»„ä»¶çš„ props å†…è”åˆ°å‡½æ•°è°ƒç”¨ä¸­
- å‡å°‘å¯¹è±¡åˆ›å»ºçš„å¼€é”€

### 3. å‚æ•°ä¼˜åŒ–
- ç§»é™¤å‡½æ•°è°ƒç”¨æœ«å°¾çš„ null å‚æ•°
- å‡å°‘ç”Ÿæˆä»£ç çš„ä½“ç§¯

### 4. ç¼“å­˜è¡¨è¾¾å¼
- ç¼“å­˜é‡å¤è®¡ç®—çš„è¡¨è¾¾å¼
- æé«˜æ¸²æŸ“æ€§èƒ½

## ğŸ¯ æ€»ç»“

ä»£ç ç”Ÿæˆå™¨æ˜¯ç¼–è¯‘å™¨çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼Œå®ƒå°†ç»“æ„åŒ–çš„ JavaScript AST è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„æ¸²æŸ“å‡½æ•°ä»£ç ã€‚ä¸»è¦ç‰¹ç‚¹ï¼š

1. **ä¸Šä¸‹æ–‡ç®¡ç†** - é€šè¿‡ CodegenContext ç®¡ç†ä»£ç ç”ŸæˆçŠ¶æ€å’Œæ ¼å¼
2. **é€’å½’å¤„ç†** - é€šè¿‡ genNode é€’å½’å¤„ç†ä¸åŒç±»å‹çš„ AST èŠ‚ç‚¹  
3. **ä»£ç ä¼˜åŒ–** - é€šè¿‡å‚æ•°ä¼˜åŒ–ã€é™æ€æå‡ç­‰æ‰‹æ®µæå‡ç”Ÿæˆä»£ç è´¨é‡
4. **æ ¼å¼æ§åˆ¶** - é€šè¿‡ç¼©è¿›ã€æ¢è¡Œç­‰æ§åˆ¶ç”Ÿæˆä»£ç çš„å¯è¯»æ€§

æœ€ç»ˆç”Ÿæˆçš„æ¸²æŸ“å‡½æ•°å¯ä»¥ç›´æ¥åœ¨ Vue è¿è¡Œæ—¶ä¸­æ‰§è¡Œï¼Œå®Œæˆä»æ¨¡æ¿åˆ°å¯æ‰§è¡Œä»£ç çš„å®Œæ•´è½¬æ¢æµç¨‹ã€‚
