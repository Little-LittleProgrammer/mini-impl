# ç¼–è¯‘å™¨ï¼ˆCompilerï¼‰

Vue ç¼–è¯‘å™¨æ˜¯å°†æ¨¡æ¿è¯­æ³•è½¬æ¢ä¸ºå¯æ‰§è¡Œæ¸²æŸ“å‡½æ•°çš„æ ¸å¿ƒç»„ä»¶ã€‚æœ¬é¡¹ç›®çš„ç¼–è¯‘å™¨åˆ†ä¸ºä¸¤ä¸ªä¸»è¦åŒ…ï¼š

- **`compiler-core`**ï¼šå¹³å°æ— å…³çš„æ ¸å¿ƒç¼–è¯‘é€»è¾‘
- **`compiler-dom`**ï¼šDOM å¹³å°ç‰¹å®šçš„ç¼–è¯‘æ‰©å±•

## ğŸ—ï¸ ç¼–è¯‘å™¨æ¶æ„

ç¼–è¯‘å™¨é‡‡ç”¨ä¸‰é˜¶æ®µç¼–è¯‘æµç¨‹ï¼š**è§£æï¼ˆParseï¼‰** â†’ **è½¬æ¢ï¼ˆTransformï¼‰** â†’ **ä»£ç ç”Ÿæˆï¼ˆCodegenï¼‰**

### æ•´ä½“æµç¨‹

```
æ¨¡æ¿å­—ç¬¦ä¸² â†’ AST â†’ JavaScript AST â†’ æ¸²æŸ“å‡½æ•°ä»£ç 
```

```mermaid
sequenceDiagram
    participant Template as æ¨¡æ¿å­—ç¬¦ä¸²
    participant Parser as è§£æå™¨ (Parser)
    participant AST as æŠ½è±¡è¯­æ³•æ ‘ (AST)
    participant Transformer as è½¬æ¢å™¨ (Transformer)
    participant JAST as JavaScript AST
    participant Codegen as ä»£ç ç”Ÿæˆå™¨
    participant Code as æ¸²æŸ“å‡½æ•°ä»£ç 
    
    Template->>Parser: 1. è¾“å…¥æ¨¡æ¿
    Note over Parser: è¯æ³•åˆ†æ & è¯­æ³•åˆ†æ
    Parser->>AST: 2. ç”Ÿæˆåˆå§‹ AST
    
    AST->>Transformer: 3. å¼€å§‹è½¬æ¢
    Note over Transformer: æ·±åº¦ä¼˜å…ˆéå†
    
    loop å¯¹æ¯ä¸ªèŠ‚ç‚¹
        Transformer->>Transformer: åº”ç”¨è½¬æ¢å‡½æ•°
        Note right of Transformer: transformElement<br/>transformText<br/>transformIf
    end
    
    Transformer->>JAST: 4. ç”Ÿæˆ JavaScript AST
    
    JAST->>Codegen: 5. å¼€å§‹ä»£ç ç”Ÿæˆ
    
    Note over Codegen: åˆ›å»ºä»£ç ä¸Šä¸‹æ–‡<br/>ç”Ÿæˆå‡½æ•°å£°æ˜<br/>å¤„ç†å¸®åŠ©å‡½æ•°
    
    loop é€’å½’å¤„ç†èŠ‚ç‚¹
        Codegen->>Codegen: ç”Ÿæˆå¯¹åº”ä»£ç ç‰‡æ®µ
    end
    
    Codegen->>Code: 6. è¾“å‡ºæ¸²æŸ“å‡½æ•°
    
    Note over Code: å¯æ‰§è¡Œçš„ JavaScript å‡½æ•°
```


## ğŸ” è¯¦ç»†åŸç†ä¸æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šParseï¼ˆè§£æï¼‰

**ç›®æ ‡**ï¼šå°†æ¨¡æ¿å­—ç¬¦ä¸²è§£æä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰

#### æ ¸å¿ƒæ–‡ä»¶
- `parse.ts` - ä¸»è¦è§£æé€»è¾‘

#### å·¥ä½œåŸç†

1. **è¯æ³•åˆ†æï¼ˆTokenizationï¼‰**
   - å°†æ¨¡æ¿å­—ç¬¦ä¸²åˆ†è§£ä¸ºä¸€ç³»åˆ— token
   - è¯†åˆ«æ ‡ç­¾ã€æ–‡æœ¬ã€æ’å€¼è¡¨è¾¾å¼ã€æŒ‡ä»¤ç­‰

2. **è¯­æ³•åˆ†æï¼ˆParsingï¼‰**
   - åŸºäº token æ„å»º AST èŠ‚ç‚¹
   - å¤„ç†åµŒå¥—ç»“æ„å’ŒèŠ‚ç‚¹å…³ç³»

#### æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹

```typescript
enum NodeTypes {
  ROOT,           // æ ¹èŠ‚ç‚¹
  ELEMENT,        // å…ƒç´ èŠ‚ç‚¹ <div>
  TEXT,           // æ–‡æœ¬èŠ‚ç‚¹
  INTERPOLATION,  // æ’å€¼è¡¨è¾¾å¼ {{ }}
  DIRECTIVE,      // æŒ‡ä»¤ v-if, v-for
  ATTRIBUTE,      // å±æ€§
  // ... æ›´å¤šç±»å‹
}
```

#### è§£æç¤ºä¾‹

**è¾“å…¥æ¨¡æ¿ï¼š**
```html
<div>{{ msg }}</div>
```

**ç”Ÿæˆçš„ ASTï¼š**
```javascript
{
  type: NodeTypes.ROOT,
  children: [{
    type: NodeTypes.ELEMENT,
    tag: 'div',
    children: [{
      type: NodeTypes.INTERPOLATION,
      content: {
        type: NodeTypes.SIMPLE_EXPRESSION,
        content: 'msg'
      }
    }]
  }]
}
```

### ç¬¬äºŒé˜¶æ®µï¼šTransformï¼ˆè½¬æ¢ï¼‰

**ç›®æ ‡**ï¼šå¯¹ AST è¿›è¡Œä¼˜åŒ–å’Œè½¬æ¢ï¼Œç”Ÿæˆ JavaScript AST

#### æ ¸å¿ƒæ–‡ä»¶
- `transform.ts` - è½¬æ¢æ¡†æ¶
- `transforms/transformElement.ts` - å…ƒç´ è½¬æ¢
- `transforms/transformText.ts` - æ–‡æœ¬è½¬æ¢  
- `transforms/vIf.ts` - v-if æŒ‡ä»¤è½¬æ¢

#### è½¬æ¢ç‰¹ç‚¹

1. **æ·±åº¦ä¼˜å…ˆéå†**ï¼šç¡®ä¿å­èŠ‚ç‚¹å…ˆäºçˆ¶èŠ‚ç‚¹å¤„ç†
2. **åŒé˜¶æ®µå¤„ç†**ï¼šè¿›å…¥é˜¶æ®µï¼ˆæ”¶é›†ï¼‰+ é€€å‡ºé˜¶æ®µï¼ˆæ‰§è¡Œï¼‰
3. **æ’ä»¶åŒ–è®¾è®¡**ï¼šæ¯ç§èŠ‚ç‚¹ç±»å‹æœ‰å¯¹åº”çš„è½¬æ¢å‡½æ•°

#### ä¸»è¦è½¬æ¢ç±»å‹

**1. å…ƒç´ è½¬æ¢ï¼ˆtransformElementï¼‰**
```javascript
// å°†å…ƒç´ èŠ‚ç‚¹è½¬æ¢ä¸º createElementVNode è°ƒç”¨
<div></div> 
â†“
createElementVNode("div", [], [])
```

**2. æ–‡æœ¬è½¬æ¢ï¼ˆtransformTextï¼‰**
```javascript
// åˆå¹¶ç›¸é‚»çš„æ–‡æœ¬å’Œæ’å€¼è¡¨è¾¾å¼
hello {{ msg }}
â†“
"hello " + toDisplayString(msg)
```

**3. æ¡ä»¶è½¬æ¢ï¼ˆtransformIfï¼‰**
```javascript
// å°† v-if è½¬æ¢ä¸ºæ¡ä»¶è¡¨è¾¾å¼
<h1 v-if="show">Title</h1>
â†“
show ? createElementVNode("h1", null, "Title") : createCommentVNode("v-if")
```

#### è½¬æ¢ä¸Šä¸‹æ–‡

```typescript
interface TransformContext {
  root: any                    // AST æ ¹èŠ‚ç‚¹
  parent: ParentNode | null    // çˆ¶èŠ‚ç‚¹
  currentNode: any             // å½“å‰å¤„ç†èŠ‚ç‚¹
  helpers: Map<symbol, number> // å¸®åŠ©å‡½æ•°æ˜ å°„
  nodeTransforms: any[]        // è½¬æ¢å‡½æ•°æ•°ç»„
}
```

### ç¬¬ä¸‰é˜¶æ®µï¼šCodegenï¼ˆä»£ç ç”Ÿæˆï¼‰

**ç›®æ ‡**ï¼šå°† JavaScript AST è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„æ¸²æŸ“å‡½æ•°ä»£ç 

#### æ ¸å¿ƒæ–‡ä»¶
- `codegen.ts` - ä»£ç ç”Ÿæˆé€»è¾‘

#### ç”Ÿæˆè¿‡ç¨‹

1. **åˆ›å»ºä»£ç ä¸Šä¸‹æ–‡**ï¼šç®¡ç†ä»£ç å­—ç¬¦ä¸²ã€ç¼©è¿›ã€å¸®åŠ©å‡½æ•°ç­‰
2. **ç”Ÿæˆå‡½æ•°å‰å¯¼**ï¼šå¯¼å…¥å¿…è¦çš„å¸®åŠ©å‡½æ•°
3. **ç”Ÿæˆå‡½æ•°ä½“**ï¼šé€’å½’å¤„ç† JavaScript AST èŠ‚ç‚¹
4. **ä¼˜åŒ–è¾“å‡º**ï¼šå‹ç¼©å’Œæ ¼å¼åŒ–æœ€ç»ˆä»£ç 

#### ç”Ÿæˆç¤ºä¾‹

**JavaScript AST è¾“å…¥ï¼š**
```javascript
{
  type: NodeTypes.VNODE_CALL,
  tag: '"div"',
  children: [{ type: NodeTypes.TEXT, content: "hello" }]
}
```

**ç”Ÿæˆçš„æ¸²æŸ“å‡½æ•°ï¼š**
```javascript
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createElementVNode: _createElementVNode } = _Vue
    
    return _createElementVNode("div", null, ["hello"])
  }
}
```

## ğŸ”§ ä¸»è¦ API

### compiler-core

```typescript
// åŸºç¡€ç¼–è¯‘å‡½æ•°
export function baseCompile(template: string, options = {})

// å„é˜¶æ®µå‡½æ•°
export function baseParse(template: string)           // è§£æ
export function transform(ast: any, options: any)    // è½¬æ¢  
export function generate(ast: any)                   // ä»£ç ç”Ÿæˆ
```

### compiler-dom

```typescript
// DOM å¹³å°ç¼–è¯‘å‡½æ•°
export function compile(template: string, options?: any)
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç¼–è¯‘

```javascript
import { compile } from 'mini-vue'

const template = '<div>{{ message }}</div>'
const { code } = compile(template)

console.log(code)
// è¾“å‡ºç”Ÿæˆçš„æ¸²æŸ“å‡½æ•°ä»£ç 
```

### å¸¦æŒ‡ä»¤çš„æ¨¡æ¿

```javascript
const template = `
  <div>
    <h1 v-if="show">{{ title }}</h1>
    <p>{{ content }}</p>
  </div>
`

const { code } = compile(template)
// ç”ŸæˆåŒ…å«æ¡ä»¶æ¸²æŸ“çš„å‡½æ•°ä»£ç 
```

### è¿è¡Œæ—¶ä½¿ç”¨

```javascript
const { compile, h, render } = Vue

// ç¼–è¯‘æ¨¡æ¿
const renderFn = compile('<div>Hello {{ name }}</div>')

// åˆ›å»ºç»„ä»¶
const component = {
  data: () => ({ name: 'Vue' }),
  render: renderFn
}

// æ¸²æŸ“åˆ°é¡µé¢
render(h(component), document.getElementById('app'))
```

## ğŸ¯ è®¾è®¡ç‰¹ç‚¹

### 1. æ¨¡å—åŒ–è®¾è®¡
- æ ¸å¿ƒé€»è¾‘ä¸å¹³å°ç‰¹å®šé€»è¾‘åˆ†ç¦»
- è½¬æ¢å‡½æ•°æ’ä»¶åŒ–ï¼Œæ˜“äºæ‰©å±•

### 2. æ€§èƒ½ä¼˜åŒ–
- é™æ€æå‡ï¼šè¯†åˆ«é™æ€å†…å®¹ï¼Œé¿å…é‡å¤åˆ›å»º
- æ·±åº¦ä¼˜å…ˆéå†ï¼šç¡®ä¿æ­£ç¡®çš„å¤„ç†é¡ºåº
- å¸®åŠ©å‡½æ•°ç¼“å­˜ï¼šé¿å…é‡å¤å¯¼å…¥

### 3. é”™è¯¯å¤„ç†
- ä½ç½®ä¿¡æ¯è·Ÿè¸ªï¼šå‡†ç¡®å®šä½é”™è¯¯ä½ç½®
- æ¸è¿›å¼è§£æï¼šå°½å¯èƒ½è§£ææœ‰æ•ˆéƒ¨åˆ†

### 4. æ‰©å±•æ€§
- è‡ªå®šä¹‰è½¬æ¢å‡½æ•°æ”¯æŒ
- å¹³å°ç‰¹å®šç¼–è¯‘å™¨æ‰©å±•

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ AST
```javascript
import { baseParse } from 'mini-vue/compiler-core'

const ast = baseParse('<div>{{ msg }}</div>')
console.log(JSON.stringify(ast, null, 2))
```

### æŸ¥çœ‹è½¬æ¢ç»“æœ
```javascript
import { baseCompile } from 'mini-vue/compiler-core'

const result = baseCompile('<div>{{ msg }}</div>')
console.log('Generated code:', result.code)
```

## ğŸ“š ç›¸å…³ç¤ºä¾‹

å®Œæ•´çš„ç¼–è¯‘å™¨ä½¿ç”¨ç¤ºä¾‹å¯ä»¥åœ¨ä»¥ä¸‹ç›®å½•æ‰¾åˆ°ï¼š

- `packages/vue/examples/compiler/compiler.html` - åŸºç¡€ç¼–è¯‘ç¤ºä¾‹
- `packages/vue/examples/compiler/compiler-directive.html` - æŒ‡ä»¤ç¼–è¯‘ç¤ºä¾‹
- `packages/vue/examples/compiler/compiler-children.html` - å­èŠ‚ç‚¹å¤„ç†ç¤ºä¾‹

## ğŸš€ æ‰©å±•ç¼–è¯‘å™¨

### æ·»åŠ è‡ªå®šä¹‰è½¬æ¢

```javascript
function customTransform(node, context) {
  if (node.type === NodeTypes.ELEMENT && node.tag === 'custom') {
    // è‡ªå®šä¹‰è½¬æ¢é€»è¾‘
    return function exitTransform() {
      // é€€å‡ºæ—¶æ‰§è¡Œçš„é€»è¾‘
    }
  }
}

// ä½¿ç”¨è‡ªå®šä¹‰è½¬æ¢
const options = {
  nodeTransforms: [customTransform]
}
```

### å¹³å°ç‰¹å®šæ‰©å±•

```javascript
// ç»§æ‰¿ compiler-core åˆ›å»ºå¹³å°ç‰¹å®šç¼–è¯‘å™¨
import { baseCompile } from 'compiler-core'

export function platformCompile(template, options) {
  return baseCompile(template, {
    ...options,
    // å¹³å°ç‰¹å®šé…ç½®
  })
}
```

ç¼–è¯‘å™¨æ˜¯ Vue æ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œç†è§£å…¶å·¥ä½œåŸç†æœ‰åŠ©äºæ›´å¥½åœ°ä½¿ç”¨å’Œæ‰©å±• Vue çš„åŠŸèƒ½ã€‚ 